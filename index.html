
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Macro Object Program — Minor Planet Center Style</title>

<!-- Professional font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  
  :root{
  --accent-blue:#1f4fd8;
  --accent-amber:#d39c2c; /* amber/yellow used across the site */
  --accent-amber-dark:#b07a1a; /* darker for contrast when needed */
  --text-main:#111;
  --text-muted:#555;
  --border-light:#e0e0e0;
  --bg:#ffffff;
}

/* Nav buttons: use amber for text, keep hover and active states subtle */
nav .links button{
  background:none;
  border:none;
  margin-left:28px;
  font-size:14px;
  font-weight:500;
  cursor:pointer;
  color:var(--accent-amber);            /* <-- yellow/amber nav text */
  text-shadow: 0 1px 0 rgba(255,255,255,0.06); /* subtle lift for readability */
  transition: color 160ms ease, transform 160ms ease;
  padding:6px 8px;
  border-radius:6px;
}

/* Hover and focus states */
nav .links button:hover,
nav .links button:focus{
  color:var(--accent-amber-dark);       /* slightly darker on hover */
  transform: translateY(-1px);
  outline: none;
  box-shadow: 0 6px 18px rgba(11,66,136,0.06);
}

/* Active page indicator */
nav .links button.active{
  color:var(--accent-amber-dark);
  background: rgba(211,156,44,0.06);
  border: 1px solid rgba(211,156,44,0.08);
  font-weight:600;
}

  
  :root{
    --bg:#ffffff;
    --text:#0b0b0b;
    --muted:#6b6b6b;
    --accent-blue:#0b66ff;
    --accent-amber:#ff9f1c;
    --panel:#f7f7f8;
    --glass: rgba(11,11,11,0.04);
    --radius:8px;
    --max-width:1200px;
  }
  
  body {
  overscroll-behavior-y: auto;
}


  #sim-canvas {
  touch-action: none; /* FULL control */
}


  
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue";-webkit-font-smoothing:antialiased;}
  .wrap{max-width:var(--max-width);margin:28px auto;padding:24px;}
  header{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #e6e6e6;padding-bottom:18px;margin-bottom:22px;}
  .brand{display:flex;align-items:center;gap:14px;}
  .logo{
    width:56px;height:56px;border-radius:6px;background:linear-gradient(135deg,var(--accent-amber),#ffd9a6);
    display:flex;align-items:center;justify-content:center;color:#111;font-weight:700;font-size:18px;box-shadow:0 2px 6px rgba(0,0,0,0.06);
  }
  .title{font-weight:700;font-size:18px;}
  nav{display:flex;gap:12px;align-items:center;}
  .nav-btn{
    background:transparent;border:0;padding:10px 14px;border-radius:6px;color:var(--text);font-weight:600;cursor:pointer;
  }
  .nav-btn:hover{background:var(--glass);}
  .nav-btn.active{background:linear-gradient(180deg,#f5f7fb,#eef4ff);box-shadow:inset 0 -1px 0 rgba(0,0,0,0.02);color:var(--accent-blue);}
  main{display:flex;gap:20px;min-height:60vh;}
  /* left column content */
  .content{flex:1;background:transparent;padding:18px;border-radius:10px;}
  .panel{background:var(--panel);padding:16px;border-radius:10px;border:1px solid #eee;}
  h1{margin:0 0 8px 0;font-size:20px;}
  p.lead{color:var(--muted);margin-top:6px;}
  /* Observers list */
  .obs-list{columns:2;column-gap:28px;padding:12px 6px;}
  .obs-list a{display:block;color:var(--text);text-decoration:none;padding:6px 0;border-bottom:1px dashed rgba(0,0,0,0.03);font-size:14px;}
  .obs-list a:hover{color:var(--accent-blue);text-decoration:underline;}
  /* Documentation */
  .doc-list{display:flex;flex-direction:column;gap:10px;padding:12px 6px;}
  .doc-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;background:white;border:1px solid #eee;}
  .btn{background:var(--accent-blue);color:white;padding:8px 12px;border-radius:6px;border:0;font-weight:600;cursor:pointer;}
  .btn.secondary{background:transparent;color:var(--accent-blue);border:1px solid rgba(11,102,255,0.12);}
  /* Publication / Game area */
  .game-area{flex:2;display:flex;flex-direction:column;gap:12px;}
  .game-top{display:flex;align-items:center;gap:12px;}
  .admin-btn{background:#fff;border:1px solid #ddd;padding:10px 12px;border-radius:6px;cursor:pointer;}
  /* Fancy modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:60;}
  .modal{background:white;padding:20px;border-radius:12px;max-width:520px;width:92%;box-shadow:0 12px 40px rgba(0,0,0,0.25);}
  .modal h3{margin:0 0 8px 0;}
  .input{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;font-size:15px;}
  .fancy{background:linear-gradient(90deg,var(--accent-amber),#ffb86b);color:#111;padding:10px 12px;border-radius:8px;border:0;font-weight:700;cursor:pointer;}
  /* Left object panel */
  .object-panel{position:fixed;left:18px;top:110px;width:320px;max-height:70vh;overflow:auto;background:white;border:1px solid #eee;padding:14px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.06);display:none;z-index:50;}
  .object-panel h4{margin:0 0 8px 0;}
  .object-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #f0f0f0;color:var(--muted);}
  .publish-input{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-top:8px;}
  /* Publication list modal */
  .pub-list{display:flex;flex-direction:column;gap:8px;}
  .pub-item{padding:10px;border-radius:8px;background:#fff;border:1px solid #eee;display:flex;justify-content:space-between;align-items:center;}
  .small{font-size:13px;color:var(--muted);}
  /* Game canvas */
  .game-canvas-wrap{flex:1;border-radius:10px;border:1px solid #eee;background:linear-gradient(180deg,#ffffff,#fbfdff);overflow:hidden;position:relative;display:flex;flex-direction:column;}
  canvas{display:block;width:100%;height:100%;}
  .hud{position:absolute;right:12px;top:12px;background:rgba(255,255,255,0.9);padding:8px;border-radius:8px;border:1px solid #eee;font-size:13px;box-shadow:0 6px 20px rgba(0,0,0,0.06);}
  .footer-note{font-size:13px;color:var(--muted);margin-top:12px;}
  /* Details page overlay */
  .details{position:fixed;inset:0;background:rgba(255,255,255,0.95);display:none;z-index:80;padding:28px;overflow:auto;}
  .details .card{max-width:900px;margin:0 auto;background:white;padding:18px;border-radius:10px;border:1px solid #eee;}
  table{width:100%;border-collapse:collapse;margin-top:12px;}
  th,td{padding:8px;border-bottom:1px solid #f2f2f2;text-align:left;font-size:14px;}
  th{background:#fafafa;font-weight:700;}
  /* responsive */
  @media (max-width:900px){
    .obs-list{columns:1;}
    main{flex-direction:column;}
    .object-panel{position:static;width:auto;max-height:none;display:none;}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">MOP</div>
        <div>
          <div class="title">Macro Object Program</div>
          <div class="small" style="color:var(--muted);font-size:13px">BC Astrophysical Observatory </div>
        </div>
      </div>

      <nav aria-label="Main navigation">
        <button class="nav-btn active" data-page="home">External</button>
        <button class="nav-btn" data-page="observers">Observers</button>
        <button class="nav-btn" data-page="documentation">Documentation</button>
        <button class="nav-btn" data-page="publication">Publication</button>
      </nav>
    </header>

    <main>
  <!-- HOME -->
  <section class="content" id="page-home">
    <div class="panel">
      <h1>Welcome to the Macro Object Program</h1>
      <p class="lead">
       The Macro Object Program (MOP) is the internationally recognized authority responsible for the collection, verification, and dissemination of astrometric observations of small Solar System bodies, including asteroids, comets, and distant trans-Neptunian objects. Operating under the auspices of the International Astronomical Union, the MOP maintains the definitive global database of orbital measurements, computes precise orbits, assigns provisional and permanent designations, and serves as the central hub linking observatories, survey programs, and planetary defense efforts worldwide. Its work is foundational to Solar System dynamics research, near-Earth object monitoring, and long-term assessment of impact hazards.
      </p>

      <div style="margin-top:14px;">
        <strong style="color:var(--muted)">Style notes:</strong>
        <div class="footer-note">
          White background, black text, subtle grey accents, and restrained
          blue/amber highlights for emphasis. Professional typography and layout
          throughout.
        </div>
      </div>
    </div>
  </section>

  <!-- OBSERVERS -->
  <section class="content" id="page-observers" style="display:none;">
    <div class="panel">
      <h2>Observers</h2>
      <p class="small">
        A curated list of organizations and observatories relevant to macro-object
        observation and research.
      </p>
      <div class="obs-list" id="obs-list"></div>
    </div>
  </section>

  <!-- DOCUMENTATION -->
  <section class="content" id="page-documentation" style="display:none;">
    <div class="panel">
      <h2>Documentation</h2>

      <div class="doc-list">
        <div class="doc-item">
          <div>
            <div style="font-weight:700">QA-DES</div>
            <div class="small">
Usage programs
            </div>
          </div>
          <div>
            <button class="btn secondary" id="open-qa">Open</button>
          </div>
        </div>

        <div class="doc-item">
          <div>
            
            <div class="small">
            
            </div>
          </div>
          <div>

          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- PUBLICATION / SIMULATION -->
  <section class="game-area" id="page-publication" style="display:none;">
    <div class="game-top">
      <div style="flex:1">
        <div style="font-weight:700">Publication Portal</div>
        <div class="small">
          Professional servers only can use this page
        </div>
      </div>
      <div>
        <button class="admin-btn" id="admin-open">
          Administrator Publication Clone
        </button>
      </div>
    </div>

    <div class="game-canvas-wrap panel" id="game-screen"
     style="min-height:520px; display:none;">

      <div
        style="
          display:flex;
          align-items:center;
          justify-content:space-between;
          margin-bottom:8px;
        "
      >
        <div style="font-weight:700">Simulation</div>
        <div class="small">
          Pan with mouse or touch. Click grey dots to inspect. Publish discoveries
          to record them.
        </div>
      </div>

      <div style="flex:1;position:relative;height:100%;">
        <canvas id="sim-canvas" tabindex="0"></canvas>
        <div class="hud" id="hud">
          Objects discovered: <strong id="count">0</strong>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top:8px;">
      <div
        style="
          display:flex;
          justify-content:space-between;
          align-items:center;
        "
      >
        <div>
          <strong>Publication Records</strong>
          <div class="small">
            
          </div>
        </div>
        <div>
          <button class="btn secondary" id="open-pub-list">
            Records
          </button>
        </div>
      </div>
    </div>
  </section>
</main>

  </div>

  <!-- Fancy modal for admin password -->
  <div class="modal-backdrop" id="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <h3 id="modal-title">Administrator Publication Clone</h3>
      <p class="small">Input clone only if you are a professional server.</p>
      <input id="admin-pass" class="input" placeholder="Clone" type="password" />
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
        <button class="btn secondary" id="modal-cancel">Cancel</button>
        <button class="btn" id="modal-submit">Enter</button>
      </div>
      <div id="modal-msg" class="small" style="margin-top:10px;color:#b00020;display:none;"></div>
    </div>
  </div>

  <!-- Object panel (left) -->
  <aside class="object-panel" id="object-panel" aria-hidden="true">
    <h4 id="obj-title">Object</h4>
    <div class="object-row"><div class="small">Mass</div><div id="obj-mass">—</div></div>
    <div class="object-row"><div class="small">Density</div><div id="obj-density">—</div></div>
    <div class="object-row"><div class="small">Magnitude</div><div id="obj-mag">—</div></div>
    <div class="object-row"><div class="small">Size</div><div id="obj-size">—</div></div>

    <div style="margin-top:10px;">
      <label class="small">Assign ID</label>
      <input id="obj-id" class="publish-input" placeholder="Enter object ID (e.g., MOP-2026-001)" />
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button class="fancy" id="publish-btn">Publish Discovery</button>
        <button class="btn secondary" id="close-panel">Close</button>
      </div>
    </div>
  </aside>

  <!-- Publication list modal -->
  <div class="modal-backdrop" id="pub-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pub-title">
      <h3 id="pub-title">Publication Records</h3>
      <div class="pub-list" id="pub-list" style="margin-top:12px;max-height:50vh;overflow:auto;"></div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
        <button class="btn secondary" id="pub-close">Close</button>
      </div>
    </div>
  </div>

  <!-- Q&A modal -->
  <div class="modal-backdrop" id="qa-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="qa-title">
      <h3 id="qa-title"> QA-DES</h3>
      <div style="margin-top:8px;">
        <div style="font-weight:700">Q: What is this simulation?</div>
        <div class="small" style="margin-bottom:8px;">A: A professional-styled discovery game where you find and publish macro objects.</div>

        <div style="font-weight:700">Q: How are objects generated?</div>
        <div class="small" style="margin-bottom:8px;">A: Objects are procedurally generated across an effectively infinite grid using deterministic pseudo-random rules so locations are consistent across sessions on the same device.</div>

        <div style="font-weight:700">Q: How is progress saved?</div>
        <div class="small" style="margin-bottom:8px;">A: Discoveries and their metadata are stored locally in your browser's localStorage and persist on your device.</div>

        <div style="font-weight:700">Q: Can I share discoveries?</div>
        <div class="small">A: This demo stores data locally only. You can export the page HTML and share it, but server-side sharing is not included.</div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
        <button class="btn secondary" id="qa-close">Close</button>
      </div>
    </div>
  </div>

  <!-- Details overlay -->
  <div class="details" id="details" aria-hidden="true">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <h2 id="details-title">Object Details</h2>
          <div class="small" id="details-sub">Recorded on —</div>
        </div>
        <div>
          <button class="btn secondary" id="details-close">Close</button>
        </div>
      </div>

      <div id="details-table-wrap" style="margin-top:12px;"></div>
    </div>
  </div>

<script>
/*
  Macro Object Program
  - Navigation and pages
  - Observers list (50 real organizations)
  - Documentation with Q&A and download of index.html
  - Publication portal with admin password modal
  - Simulation canvas: procedurally generated infinite grid of moving dots
  - Click grey dot to inspect, publish to mark discovered (blue trail)
  - Discoveries saved to localStorage and viewable in Publication Records
*/

/* ---------- Utilities ---------- */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

/* ---------- Navigation ---------- */
const navButtons = $$('.nav-btn');
const pages = {
  home: $('#page-home'),
  observers: $('#page-observers'),
  documentation: $('#page-documentation'),
  publication: $('#page-publication')
};


function getVelocityFor(key){
  const h = hashSeed(key.length, key.charCodeAt(0) || 1, 999);
  return {
    jitter: randFromHash(h)
  };
}

function setPage(name){
  navButtons.forEach(b =>
    b.classList.toggle('active', b.dataset.page === name)
  );

  Object.entries(pages).forEach(([key, el]) => {
    if (!el) return;
    el.style.display = (key === name) ? 'flex' : 'none';
  });
}
navButtons.forEach(b=>{
  b.addEventListener('click', ()=> {
    setPage(b.dataset.page);

    if (b.dataset.page === 'publication') {
      // IMPORTANT: canvas was hidden before
      requestAnimationFrame(() => {
        resizeCanvas();
      });
    }
  });
});

setPage('home');

/* ---------- Observers list (50 links) ---------- */
const observers = [
  ["NASA","https://www.nasa.gov/"],
  ["SpaceX","https://www.spacex.com/"],
  ["European Space Agency (ESA)","https://www.esa.int/"],
  ["Jet Propulsion Laboratory (JPL)","https://www.jpl.nasa.gov/"],
  ["International Astronomical Union (IAU)","https://www.iau.org/"],
  ["Minor Planet Center (MPC)","https://minorplanetcenter.net/"],
  ["WGSBN (Working Group Small Body Nomenclature)","https://www.wgsbn-iau.org/"],
  ["SETI Institute","https://www.seti.org/"],
  ["Arecibo Observatory (archival)","https://www.naic.edu/"],
  ["NOAA","https://www.noaa.gov/"],
  ["USGS Astrogeology","https://astrogeology.usgs.gov/"],
  ["Caltech","https://www.caltech.edu/"],
  ["MIT Kavli Institute","https://www.kavli.mit.edu/"],
  ["Harvard-Smithsonian Center for Astrophysics","https://www.cfa.harvard.edu/"],
  ["Max Planck Institute for Astronomy","https://www.mpia.de/"],
  ["Space Telescope Science Institute (STScI)","https://www.stsci.edu/"],
  ["European Southern Observatory (ESO)","https://www.eso.org/"],
  ["Sloan Digital Sky Survey (SDSS)","https://www.sdss.org/"],
  ["Pan-STARRS","https://panstarrs.stsci.edu/"],
  ["LSST / Rubin Observatory","https://www.lsst.org/"],
  ["UK Space Agency","https://www.gov.uk/government/organisations/uk-space-agency"],
  ["Canadian Space Agency (CSA)","https://www.asc-csa.gc.ca/"],
  ["Indian Space Research Organisation (ISRO)","https://www.isro.gov.in/"],
  ["China National Space Administration (CNSA)","http://www.cnsa.gov.cn/"],
  ["Russian Roscosmos","https://www.roscosmos.ru/"],
  ["JAXA (Japan Aerospace Exploration Agency)","https://global.jaxa.jp/"],
  ["Australian Space Agency","https://www.industry.gov.au/strategies-for-the-future/australian-space-agency"],
  ["Space Weather Prediction Center (SWPC)","https://www.swpc.noaa.gov/"],
  ["European Space Operations Centre (ESOC)","https://www.esa.int/About_Us/ESOC"],
  ["Observatoire de Paris","https://www.observatoiredeparis.psl.eu/"],
  ["Kitt Peak National Observatory","https://www.noao.edu/kpno/"],
  ["Mauna Kea Observatories","https://www.ifa.hawaii.edu/mko/"],
  ["Palomar Observatory","https://www.astro.caltech.edu/palomar/"],
  ["AAVSO (Variable Star Obs.)","https://www.aavso.org/"],
  ["Minor Planet Center (alternate)","https://www.minorplanetcenter.net/iau/mpc.html"],
  ["International Space Science Institute (ISSI)","https://www.issibern.ch/"],
  ["Planetary Society","https://www.planetary.org/"],
  ["Space Foundation","https://www.spacefoundation.org/"],
  ["Blue Origin","https://www.blueorigin.com/"],
  ["Rocket Lab","https://www.rocketlabusa.com/"],
  ["Maxar Technologies","https://www.maxar.com/"],
  ["NOIRLab","https://noirlab.edu/"],
  ["SRI International","https://www.sri.com/"],
  ["Lockheed Martin Space","https://www.lockheedmartin.com/"],
  ["Northrop Grumman","https://www.northropgrumman.com/"],
  ["European Space Policy Institute","https://www.espi.or.at/"],
  ["SpaceIL","https://www.spaceil.com/"],
  ["Asteroid Institute","https://www.asteroidinitiative.org/"],
  ["International GNSS Service (IGS)","https://www.igs.org/"],
  ["CERN (data science collaborations)","https://home.cern/"]
];
const obsList = $('#obs-list');
observers.forEach(([name,url])=>{
  const a = document.createElement('a');
  a.href = url;
  a.target = "_blank";
  a.rel = "noopener noreferrer";
  a.textContent = name;
  obsList.appendChild(a);
});

/* ---------- Documentation: Q&A and Download ---------- */
$('#open-qa').addEventListener('click', ()=> {
  $('#qa-backdrop').style.display = 'flex';
  $('#qa-backdrop').setAttribute('aria-hidden','false');
});
$('#qa-close').addEventListener('click', ()=> {
  $('#qa-backdrop').style.display = 'none';
  $('#qa-backdrop').setAttribute('aria-hidden','true');
});

/* Download current HTML as index.html */


/* ---------- Download current HTML as index.html ---------- */
const downloadBtn = document.getElementById('download-html');

if (downloadBtn) {
  downloadBtn.addEventListener('click', () => {
    // Serialize full document exactly as loaded
    const html =
      '<!DOCTYPE html>\n' + document.documentElement.outerHTML;

    const blob = new Blob([html], {
      type: 'text/html;charset=utf-8'
    });

    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'index.html';

    // Required for Safari / WebKit
    document.body.appendChild(a);
    a.click();

    // Cleanup AFTER click
    setTimeout(() => {
      URL.revokeObjectURL(url);
      a.remove();
    }, 100);
  });
}




/* ---------- Admin modal and publication flow ---------- */
const ADMIN_PASSWORD = 'jameslidegenhardt';
$('#admin-open').addEventListener('click', ()=> {
  $('#modal-backdrop').style.display = 'flex';
  $('#modal-backdrop').setAttribute('aria-hidden','false');
  $('#admin-pass').value = '';
  $('#modal-msg').style.display = 'none';
  $('#admin-pass').focus();
});
$('#modal-cancel').addEventListener('click', ()=> {
  $('#modal-backdrop').style.display = 'none';
  $('#modal-backdrop').setAttribute('aria-hidden','true');
});
$('#modal-submit').addEventListener('click', ()=> {
  const val = $('#admin-pass').value || '';
  if(val === ADMIN_PASSWORD){
    $('#modal-backdrop').style.display = 'none';
    $('#modal-backdrop').setAttribute('aria-hidden','true');
    // reveal the play button (normal button)
    if(!$('#play-button')){
      const btn = document.createElement('button');
      btn.textContent = 'Enter Terminal';
      btn.id = 'play-button';
      btn.className = 'admin-btn';
      btn.style.marginLeft = '8px';
      btn.addEventListener('click', ()=> {
  if (simulationActive) return;

  simulationActive = true;

  // show simulation UI
  $('#game-screen').style.display = 'flex';

  // resize canvas AFTER it becomes visible
  requestAnimationFrame(() => {
    resizeCanvas();
  });

  // start simulation loop
  lastTime = performance.now();
  requestAnimationFrame(draw);

  $('#sim-canvas').focus();
});

      document.querySelector('.game-top').appendChild(btn);
      // also show publication list button enabled
    }
    // show a subtle success message
    alert('Administration Publication Clone accepted');
  } else {
    $('#modal-msg').textContent = 'Clone failed';
    $('#modal-msg').style.display = 'block';
  }
});

/* ---------- Publication list modal ---------- */
$('#open-pub-list').addEventListener('click', ()=> {
  renderPubList();
  $('#pub-backdrop').style.display = 'flex';
  $('#pub-backdrop').setAttribute('aria-hidden','false');
});
$('#pub-close').addEventListener('click', ()=> {
  $('#pub-backdrop').style.display = 'none';
  $('#pub-backdrop').setAttribute('aria-hidden','true');
});

/* ---------- Local storage helpers ---------- */
const STORAGE_KEY = 'mop_discoveries_v1';
function loadDiscoveries(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : {};
  }catch(e){ return {}; }
}
function saveDiscoveries(obj){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
}

/* ---------- Procedural object generation ---------- */
/*
  We'll simulate an effectively infinite grid by using integer cell coordinates.
  For each cell (x,y) we deterministically generate a small number of objects (0..3)
  using a seeded hash function so the same device will always see the same objects.
*/
function hashSeed(x,y,seed=0){
  // simple 32-bit mix
  let h = (x*374761393 + y*668265263 + seed*982451653) >>> 0;
  h = (h ^ (h >>> 13)) * 1274126177 >>> 0;
  return h;
}
function randFromHash(h){
  return (h >>> 0) / 4294967295;
}
function objectsInCell(cx,cy){
  const h = hashSeed(cx,cy, 12345);
  const r = randFromHash(h);
  const count = Math.floor(r * 3.2); // 0..3
  const arr = [];
  let base = h;
  for(let i=0;i<count;i++){
    base = (base * 1664525 + 1013904223) >>> 0;
    const rx = randFromHash(base);
    base = (base * 1664525 + 1013904223) >>> 0;
    const ry = randFromHash(base);
    base = (base * 1664525 + 1013904223) >>> 0;
    const size = 20.0 + randFromHash(base)*3.6; // visual size
    base = (base * 1664525 + 1013904223) >>> 0;
    const mass = (10 + randFromHash(base)*990).toFixed(2);
    base = (base * 1664525 + 1013904223) >>> 0;
    const density = (0.5 + randFromHash(base)*8.5).toFixed(3);
    base = (base * 1664525 + 1013904223) >>> 0;
    const mag = (8 + randFromHash(base)*18).toFixed(2);
    // unique id key for this object based on cell and index
    const key = `c${cx}_${cy}_i${i}`;
    arr.push({
      key, cx, cy, rx, ry, size:parseFloat(size), mass:parseFloat(mass),
      density:parseFloat(density), magnitude:parseFloat(mag)
    });
  }
  return arr;
}

/* ---------- Simulation canvas ---------- */
const canvas = $('#sim-canvas');
const ctx = canvas.getContext('2d');
let DPR = window.devicePixelRatio || 1;

let simulationActive = false;
let lastTime = 0;




function resizeCanvas(){
  DPR = window.devicePixelRatio || 1;
  canvas.width = Math.floor(canvas.clientWidth * DPR);
  canvas.height = Math.floor(canvas.clientHeight * DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

/* ---------- Touch + Mouse Camera Controls ---------- */

let view = { x: 0, y: 0, scale: 1 };

const pointers = new Map();

let isPanning = false;
let lastPan = { x: 0, y: 0 };

let pinchStartDist = 0;
let pinchStartScale = 1;



canvas.addEventListener("pointermove", e => {
  if (!pointers.has(e.pointerId)) return;

  const p = pointers.get(e.pointerId);
  p.x = e.clientX;
  p.y = e.clientY;

  // ----- ONE FINGER PAN -----
  if (pointers.size === 1 && isPanning) {
    const dx = e.clientX - lastPan.x;
    const dy = e.clientY - lastPan.y;

    view.x -= dx / view.scale;
    view.y -= dy / view.scale;

    lastPan.x = e.clientX;
    lastPan.y = e.clientY;
  }

  // ----- TWO FINGER PINCH ZOOM -----
  if (pointers.size === 2) {
    const [a, b] = [...pointers.values()];
    const dx = a.x - b.x;
    const dy = a.y - b.y;
    const dist = Math.hypot(dx, dy);

    if (!pinchStartDist) {
      pinchStartDist = dist;
      pinchStartScale = view.scale;
    } else {
      const zoom = dist / pinchStartDist;
      view.scale = Math.min(4, Math.max(0.25, pinchStartScale * zoom));
    }
  }

  e.preventDefault();
});

canvas.addEventListener("pointerup", e => {
  pointers.delete(e.pointerId);
  pinchStartDist = 0;
  isPanning = false;
  canvas.releasePointerCapture(e.pointerId);
});

canvas.addEventListener("pointercancel", e => {
  pointers.clear();
  pinchStartDist = 0;
  isPanning = false;
});

/* ---------- Click / Tap detection ---------- */

let downPos = null;

canvas.addEventListener("pointerdown", e => {
  canvas.setPointerCapture(e.pointerId);
  pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });

  downPos = { x: e.clientX, y: e.clientY };

  if (pointers.size === 1) {
    isPanning = true;
    lastPan.x = e.clientX;
    lastPan.y = e.clientY;
  }

  e.preventDefault();
});


canvas.addEventListener("pointerup", e => {
  if (!downPos) return;

  const dx = e.clientX - downPos.x;
  const dy = e.clientY - downPos.y;
  const dist = Math.hypot(dx, dy);

  // Treat as click/tap if finger/mouse didn’t move much
  if (dist < 6) {
    handleCanvasClick(e);
  }

  downPos = null;
});



canvas.addEventListener('wheel', e => {
  e.preventDefault();

  const zoomSpeed = 0.001;
  const oldScale = view.scale;
  const delta = -e.deltaY * zoomSpeed;

  view.scale = Math.max(0.25, Math.min(4, view.scale * (1 + delta)));

  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;

  const wx = view.x + mx / oldScale;
  const wy = view.y + my / oldScale;

  view.x = wx - mx / view.scale;
  view.y = wy - my / view.scale;
}, { passive: false });



// track moving dots: we will simulate small jitter velocities per object
const objectStates = new Map();

function getStateFor(o){
  if (!objectStates.has(o.key)) {
    const h = hashSeed(o.cx, o.cy, o.key.length);
    const angle = randFromHash(h) * Math.PI * 2;
    const speed = 20 + randFromHash(h>>1) * 40; // px/sec
    objectStates.set(o.key, {
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed,
      ox: (o.cx + o.rx) * 200,
      oy: (o.cy + o.ry) * 200
    });
  }
  return objectStates.get(o.key);
}


// discovered objects and trails
let discoveries = loadDiscoveries(); // { key: {id, mass, density, magnitude, size, ts, trail:[{x,y}], cx,cy,rx,ry} }
function markDiscovered(obj, assignedId){
  const now = new Date();
  const ts = now.toISOString();
  discoveries[obj.key] = {
    id: assignedId || (`MOP-${now.getFullYear()}-${Math.floor(Math.random()*9000+1000)}`),
    mass: obj.mass, density: obj.density, magnitude: obj.magnitude, size: obj.size,
    ts, cx: obj.cx, cy: obj.cy, rx: obj.rx, ry: obj.ry, key: obj.key, trail: []
  };
  saveDiscoveries(discoveries);
  updateHUD();
  renderPubList();
}

// update HUD count
function updateHUD(){
  $('#count').textContent = Object.keys(discoveries).length;
}
updateHUD();

/* Click handling: detect nearest object under pointer */
function handleCanvasClick(e){
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  const wx = view.x + mx / view.scale;
  const wy = view.y + my / view.scale;

  const found = findObjectNear(wx, wy, 14 / view.scale);
  if (found) openObjectPanel(found);
}


// find object near world coords
function findObjectNear(wx,wy,threshold){
  // check cells around point
  const cellSize = 200; // world cell size in pixels
  const cx = Math.floor(wx / cellSize);
  const cy = Math.floor(wy / cellSize);
  for(let dx=-1;dx<=1;dx++){
    for(let dy=-1;dy<=1;dy++){
      const arr = objectsInCell(cx+dx, cy+dy);
      for(const o of arr){
        // compute object's world position
        const state = getStateFor(o);
const px = state.ox;
const py = state.oy;

        const dist = Math.hypot(px - wx, py - wy);
        if(dist <= threshold){
          // return object with current position
          return {...o, worldX:px, worldY:py};
        }
      }
    }
  }
  return null;
}

/* Object panel interactions */
function openObjectPanel(obj){
  $('#object-panel').style.display = 'block';
  $('#object-panel').setAttribute('aria-hidden','false');
  $('#obj-title').textContent = `Object ${obj.key}`;
  $('#obj-mass').textContent = `${obj.mass} kg`;
  $('#obj-density').textContent = `${obj.density} g/cm³`;
  $('#obj-mag').textContent = `${obj.magnitude}`;
  $('#obj-size').textContent = `${obj.size} km`;
  $('#obj-id').value = discoveries[obj.key] ? discoveries[obj.key].id : '';
  // store current inspected object
  $('#publish-btn').dataset.current = JSON.stringify(obj);
}
$('#close-panel').addEventListener('click', ()=> {
  $('#object-panel').style.display = 'none';
  $('#object-panel').setAttribute('aria-hidden','true');
});
$('#publish-btn').addEventListener('click', ()=> {
  const obj = JSON.parse($('#publish-btn').dataset.current || '{}');
  const assigned = $('#obj-id').value.trim() || null;
  if(!obj || !obj.key) return;
  markDiscovered(obj, assigned);
  // close panel
  $('#object-panel').style.display = 'none';
  $('#object-panel').setAttribute('aria-hidden','true');
});

/* Render publication list */
function renderPubList(){
  const wrap = $('#pub-list');
  wrap.innerHTML = '';
  const data = loadDiscoveries();
  const keys = Object.keys(data).sort((a,b)=> new Date(data[b].ts) - new Date(data[a].ts));
  if(keys.length===0){
    const none = document.createElement('div');
    none.className = 'small';
    none.textContent = 'No discoveries yet.';
    wrap.appendChild(none);
    return;
  }
  keys.forEach(k=>{
    const d = data[k];
    const item = document.createElement('div');
    item.className = 'pub-item';
    const left = document.createElement('div');
    left.innerHTML = `<div style="font-weight:700">${d.id}</div><div class="small">${new Date(d.ts).toLocaleString()}</div>`;
    const right = document.createElement('div');
    const viewBtn = document.createElement('button');
    viewBtn.className = 'btn';
    viewBtn.textContent = 'View';
    viewBtn.addEventListener('click', ()=> openDetails(d));
    right.appendChild(viewBtn);
    item.appendChild(left);
    item.appendChild(right);
    wrap.appendChild(item);
  });
}

/* Details overlay */
function openDetails(d){
  $('#details-title').textContent = d.id;
  $('#details-sub').textContent = `Recorded on ${new Date(d.ts).toLocaleString()}`;
  const wrap = $('#details-table-wrap');
  wrap.innerHTML = '';
  const table = document.createElement('table');
  table.innerHTML = `
    <thead><tr><th>Property</th><th>Value</th></tr></thead>
    <tbody>
      <tr><td>Key</td><td>${d.key}</td></tr>
      <tr><td>Mass (kg)</td><td>${d.mass}</td></tr>
      <tr><td>Density (g/cm³)</td><td>${d.density}</td></tr>
      <tr><td>Magnitude</td><td>${d.magnitude}</td></tr>
      <tr><td>Size (km)</td><td>${d.size}</td></tr>
      <tr><td>Cell</td><td>${d.cx}, ${d.cy}</td></tr>
      <tr><td>Relative pos</td><td>${d.rx.toFixed(3)}, ${d.ry.toFixed(3)}</td></tr>
    </tbody>
  `;
  wrap.appendChild(table);
  $('#details').style.display = 'block';
  $('#details').setAttribute('aria-hidden','false');
}
$('#details-close').addEventListener('click', ()=> {
  $('#details').style.display = 'none';
  $('#details').setAttribute('aria-hidden','true');
});

/* ---------- Simulation draw loop ---------- */
lastTime = performance.now();

function draw(){
  if (!simulationActive) return;

  const now = performance.now();
  const dt = (now - lastTime) * 0.001;
  lastTime = now;


  // clear
  for (const state of objectStates.values()) {
  state.ox += state.vx * dt;
  state.oy += state.vy * dt;
}

  
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // draw grid faint
  drawGrid();

  // determine visible world bounds
  const w = canvas.clientWidth;
  const h = canvas.clientHeight;
  const left = view.x;
  const top = view.y;
  const right = view.x + w / view.scale;
  const bottom = view.y + h / view.scale;

  // cell size consistent with generation
  const cellSize = 200;
  const minCx = Math.floor(left / cellSize) - 2;
  const maxCx = Math.floor(right / cellSize) + 2;
  const minCy = Math.floor(top / cellSize) - 2;
  const maxCy = Math.floor(bottom / cellSize) + 2;

  // draw objects
  for(let cx=minCx; cx<=maxCx; cx++){
    for(let cy=minCy; cy<=maxCy; cy++){
      const arr = objectsInCell(cx,cy);
      for(const o of arr){
        // compute world pos with motion
        const ox = (o.cx + o.rx) * cellSize;
        const oy = (o.cy + o.ry) * cellSize;
        const vel = getVelocityFor(o.key);
        const t = now * 0.001;
        const jitterX = Math.sin(t * (0.5 + vel.jitter*2) + (o.cx*13 + o.cy*7)) * 6 * vel.jitter;
        const jitterY = Math.cos(t * (0.6 + vel.jitter*1.7) + (o.cx*11 + o.cy*5)) * 6 * vel.jitter;
        const state = getStateFor(o);
const px = state.ox;
const py = state.oy;


        // update trail if discovered
        if(discoveries[o.key]){
          const rec = discoveries[o.key];
          // push current pos to trail (limit length)
          rec.trail = rec.trail || [];
          rec.trail.push({x:px,y:py});
          if(rec.trail.length > 60) rec.trail.shift();
        }

        // draw trail if discovered
        if(discoveries[o.key] && discoveries[o.key].trail && discoveries[o.key].trail.length>1){
          ctx.save();
          ctx.beginPath();
          const trail = discoveries[o.key].trail;
          for(let i=0;i<trail.length;i++){
            const p = worldToScreen(trail[i].x, trail[i].y);
            if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y);
          }
          ctx.strokeStyle = 'rgba(11,102,255,0.9)';
          ctx.lineWidth = 2;
          ctx.stroke();
          ctx.restore();
        }

        // draw dot
        const scr = worldToScreen(px,py);
        const radius = Math.max(1, o.size * 0.6 * view.scale * 0.6);
        ctx.beginPath();
        ctx.arc(scr.x, scr.y, radius, 0, Math.PI*2);
        if(discoveries[o.key]){
          // discovered: blue filled
          ctx.fillStyle = 'rgba(11,102,255,0.95)';
          ctx.fill();
          ctx.strokeStyle = 'rgba(0,0,0,0.06)';
          ctx.lineWidth = 0.5;
          ctx.stroke();
        } else {
          // undiscovered: grey
          ctx.fillStyle = 'rgba(120,120,120,0.9)';
          ctx.fill();
        }
      }
    }
  }

  // subtle overlay text
  ctx.save();
  ctx.fillStyle = 'rgba(0,0,0,0.06)';
  ctx.font = '12px Inter, system-ui';
  ctx.fillText('Macro Object Program — Simulation', 12, canvas.clientHeight - 12);
  ctx.restore();

  requestAnimationFrame(draw);
}
function worldToScreen(wx,wy){
  return {x: Math.round((wx - view.x) * view.scale), y: Math.round((wy - view.y) * view.scale)};
}
function drawGrid(){
  const w = canvas.clientWidth;
  const h = canvas.clientHeight;
  const left = view.x;
  const top = view.y;
  const right = view.x + w / view.scale;
  const bottom = view.y + h / view.scale;
  const cellSize = 200;
  const minCx = Math.floor(left / cellSize) - 2;
  const maxCx = Math.floor(right / cellSize) + 2;
  const minCy = Math.floor(top / cellSize) - 2;
  const maxCy = Math.floor(bottom / cellSize) + 2;

  ctx.save();
  ctx.strokeStyle = 'rgba(0,0,0,0.03)';
  ctx.lineWidth = 1;
  for(let cx=minCx;cx<=maxCx;cx++){
    const x = Math.round((cx*cellSize - view.x) * view.scale);
    ctx.beginPath();
    ctx.moveTo(x,0);
    ctx.lineTo(x,canvas.clientHeight);
    ctx.stroke();
  }
  for(let cy=minCy;cy<=maxCy;cy++){
    const y = Math.round((cy*cellSize - view.y) * view.scale);
    ctx.beginPath();
    ctx.moveTo(0,y);
    ctx.lineTo(canvas.clientWidth,y);
    ctx.stroke();
  }
  ctx.restore();
}

// start loop
requestAnimationFrame(draw);

/* ---------- Initialization ---------- */
(function init(){
  // center view on a pleasing coordinate
  view.x = -400;
  view.y = -200;
  view.scale = 1.0;
  resizeCanvas();
  updateHUD();
})();

/* ---------- Accessibility & small UX ---------- */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){
    // close modals/panels
    $('#modal-backdrop').style.display = 'none';
    $('#pub-backdrop').style.display = 'none';
    $('#qa-backdrop').style.display = 'none';
    $('#object-panel').style.display = 'none';
    $('#details').style.display = 'none';
  }
});

/* ---------- Small polish: show observers/documentation when nav clicked ---------- */
$$('.nav-btn').forEach(b=>{
  b.addEventListener('click', ()=>{
    if(b.dataset.page === 'observers'){
      $('#observers-panel').style.display = 'block';
    } else {
      $('#observers-panel').style.display = 'none';
    }
    if(b.dataset.page === 'documentation'){
      $('#documentation-panel').style.display = 'block';
    } else {
      $('#documentation-panel').style.display = 'none';
    }
  });
});



</script>

</body>
</html>
